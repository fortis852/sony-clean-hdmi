name: Build Clean HDMI Final Version

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/clean-hdmi-final.yml'

jobs:
  build-clean-hdmi:
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
    
    - name: Download base app and tools
      run: |
        echo "📥 Setting up environment..."
        mkdir -p work
        cd work
        
        # Download working base APK
        wget https://github.com/ma1co/PMCADemo/releases/download/v0.7/PMCADemo-release-0.7.apk -O base.apk
        
        # Download apktool
        wget https://github.com/iBotPeaches/Apktool/releases/download/v2.9.0/apktool_2.9.0.jar -O apktool.jar
        
        echo "✅ Environment ready"
    
    - name: Decompile base APK
      run: |
        echo "🔧 Decompiling base APK..."
        cd work
        
        java -jar apktool.jar d -f base.apk -o app
        
        echo "📁 App structure:"
        ls -la app/
    
    - name: Create Clean HDMI functionality
      run: |
        echo "💻 Creating Clean HDMI code..."
        cd work/app
        
        # Create main Clean HDMI activity
        mkdir -p smali/com/cleanhdmi
        
        cat > smali/com/cleanhdmi/MainActivity.smali << 'EOF'
        .class public Lcom/cleanhdmi/MainActivity;
        .super Landroid/app/Activity;
        .source "MainActivity.java"
        
        # instance fields
        .field private cameraDevice:Ljava/lang/Object;
        .field private isCleanMode:Z
        .field private previewView:Landroid/view/SurfaceView;
        .field private statusText:Landroid/widget/TextView;
        .field private controlLayout:Landroid/widget/LinearLayout;
        
        # direct methods
        .method public constructor <init>()V
            .locals 0
            
            .prologue
            .line 10
            invoke-direct {p0}, Landroid/app/Activity;-><init>()V
            
            return-void
        .end method
        
        # virtual methods
        .method protected onCreate(Landroid/os/Bundle;)V
            .locals 8
            .param p1, "savedInstanceState"
            
            .prologue
            .line 20
            invoke-super {p0, p1}, Landroid/app/Activity;->onCreate(Landroid/os/Bundle;)V
            
            # Request fullscreen
            .line 23
            invoke-virtual {p0}, Lcom/cleanhdmi/MainActivity;->getWindow()Landroid/view/Window;
            move-result-object v5
            
            const/16 v6, 0x400
            invoke-virtual {v5, v6, v6}, Landroid/view/Window;->setFlags(II)V
            
            # Hide action bar
            const/4 v6, 0x1
            invoke-virtual {p0, v6}, Lcom/cleanhdmi/MainActivity;->requestWindowFeature(I)Z
            
            # Create main layout
            .line 28
            new-instance v0, Landroid/widget/FrameLayout;
            invoke-direct {v0, p0}, Landroid/widget/FrameLayout;-><init>(Landroid/content/Context;)V
            .local v0, "mainLayout":Landroid/widget/FrameLayout;
            
            const/high16 v6, -0x1000000
            invoke-virtual {v0, v6}, Landroid/widget/FrameLayout;->setBackgroundColor(I)V
            
            # Create preview surface
            .line 32
            new-instance v1, Landroid/view/SurfaceView;
            invoke-direct {v1, p0}, Landroid/view/SurfaceView;-><init>(Landroid/content/Context;)V
            iput-object v1, p0, Lcom/cleanhdmi/MainActivity;->previewView:Landroid/view/SurfaceView;
            
            .local v1, "preview":Landroid/view/SurfaceView;
            new-instance v2, Landroid/widget/FrameLayout$LayoutParams;
            const/4 v6, -0x1
            const/4 v7, -0x1
            invoke-direct {v2, v6, v7}, Landroid/widget/FrameLayout$LayoutParams;-><init>(II)V
            
            invoke-virtual {v0, v1, v2}, Landroid/widget/FrameLayout;->addView(Landroid/view/View;Landroid/view/ViewGroup$LayoutParams;)V
            
            # Create control overlay
            .line 38
            new-instance v3, Landroid/widget/LinearLayout;
            invoke-direct {v3, p0}, Landroid/widget/LinearLayout;-><init>(Landroid/content/Context;)V
            iput-object v3, p0, Lcom/cleanhdmi/MainActivity;->controlLayout:Landroid/widget/LinearLayout;
            
            .local v3, "controls":Landroid/widget/LinearLayout;
            const/4 v6, 0x1
            invoke-virtual {v3, v6}, Landroid/widget/LinearLayout;->setOrientation(I)V
            
            const v6, -0x7f000001
            invoke-virtual {v3, v6}, Landroid/widget/LinearLayout;->setBackgroundColor(I)V
            
            const/16 v6, 0xa
            invoke-virtual {v3, v6, v6, v6, v6}, Landroid/widget/LinearLayout;->setPadding(IIII)V
            
            # Add status text
            .line 45
            new-instance v4, Landroid/widget/TextView;
            invoke-direct {v4, p0}, Landroid/widget/TextView;-><init>(Landroid/content/Context;)V
            iput-object v4, p0, Lcom/cleanhdmi/MainActivity;->statusText:Landroid/widget/TextView;
            
            .local v4, "status":Landroid/widget/TextView;
            const-string v6, "Clean HDMI Mode"
            invoke-virtual {v4, v6}, Landroid/widget/TextView;->setText(Ljava/lang/CharSequence;)V
            
            const/high16 v6, 0x41900000    # 18.0f
            invoke-virtual {v4, v6}, Landroid/widget/TextView;->setTextSize(F)V
            
            const/4 v6, -0x1
            invoke-virtual {v4, v6}, Landroid/widget/TextView;->setTextColor(I)V
            
            invoke-virtual {v3, v4}, Landroid/widget/LinearLayout;->addView(Landroid/view/View;)V
            
            # Add control buttons
            .line 52
            invoke-direct {p0, v3}, Lcom/cleanhdmi/MainActivity;->addControlButtons(Landroid/widget/LinearLayout;)V
            
            # Add controls to layout
            .line 55
            new-instance v2, Landroid/widget/FrameLayout$LayoutParams;
            const/4 v6, -0x2
            const/4 v7, -0x2
            invoke-direct {v2, v6, v7}, Landroid/widget/FrameLayout$LayoutParams;-><init>(II)V
            
            const/16 v6, 0x33
            iput v6, v2, Landroid/widget/FrameLayout$LayoutParams;->gravity:I
            
            invoke-virtual {v0, v3, v2}, Landroid/widget/FrameLayout;->addView(Landroid/view/View;Landroid/view/ViewGroup$LayoutParams;)V
            
            # Set content view
            .line 60
            invoke-virtual {p0, v0}, Lcom/cleanhdmi/MainActivity;->setContentView(Landroid/view/View;)V
            
            # Start camera
            .line 63
            invoke-direct {p0}, Lcom/cleanhdmi/MainActivity;->initializeCamera()V
            
            # Set touch listener for toggling UI
            .line 66
            new-instance v6, Lcom/cleanhdmi/MainActivity$1;
            invoke-direct {v6, p0}, Lcom/cleanhdmi/MainActivity$1;-><init>(Lcom/cleanhdmi/MainActivity;)V
            invoke-virtual {v0, v6}, Landroid/widget/FrameLayout;->setOnClickListener(Landroid/view/View$OnClickListener;)V
            
            return-void
        .end method
        
        .method private addControlButtons(Landroid/widget/LinearLayout;)V
            .locals 4
            .param p1, "parent"
            
            .prologue
            # Add toggle button
            .line 70
            new-instance v0, Landroid/widget/Button;
            invoke-direct {v0, p0}, Landroid/widget/Button;-><init>(Landroid/content/Context;)V
            
            .local v0, "toggleBtn":Landroid/widget/Button;
            const-string v2, "Toggle Clean Mode"
            invoke-virtual {v0, v2}, Landroid/widget/Button;->setText(Ljava/lang/CharSequence;)V
            
            new-instance v2, Lcom/cleanhdmi/MainActivity$2;
            invoke-direct {v2, p0}, Lcom/cleanhdmi/MainActivity$2;-><init>(Lcom/cleanhdmi/MainActivity;)V
            invoke-virtual {v0, v2}, Landroid/widget/Button;->setOnClickListener(Landroid/view/View$OnClickListener;)V
            
            invoke-virtual {p1, v0}, Landroid/widget/LinearLayout;->addView(Landroid/view/View;)V
            
            # Add focus lock button
            .line 78
            new-instance v1, Landroid/widget/Button;
            invoke-direct {v1, p0}, Landroid/widget/Button;-><init>(Landroid/content/Context;)V
            
            .local v1, "focusBtn":Landroid/widget/Button;
            const-string v2, "Lock Focus"
            invoke-virtual {v1, v2}, Landroid/widget/Button;->setText(Ljava/lang/CharSequence;)V
            
            new-instance v2, Lcom/cleanhdmi/MainActivity$3;
            invoke-direct {v2, p0}, Lcom/cleanhdmi/MainActivity$3;-><init>(Lcom/cleanhdmi/MainActivity;)V
            invoke-virtual {v1, v2}, Landroid/widget/Button;->setOnClickListener(Landroid/view/View$OnClickListener;)V
            
            invoke-virtual {p1, v1}, Landroid/widget/LinearLayout;->addView(Landroid/view/View;)V
            
            return-void
        .end method
        
        .method private initializeCamera()V
            .locals 2
            
            .prologue
            # Initialize camera preview
            .line 90
            const-string v0, "CleanHDMI"
            const-string v1, "Initializing camera..."
            invoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
            
            # Start preview on surface
            iget-object v0, p0, Lcom/cleanhdmi/MainActivity;->previewView:Landroid/view/SurfaceView;
            invoke-virtual {v0}, Landroid/view/SurfaceView;->getHolder()Landroid/view/SurfaceHolder;
            move-result-object v0
            
            new-instance v1, Lcom/cleanhdmi/MainActivity$4;
            invoke-direct {v1, p0}, Lcom/cleanhdmi/MainActivity$4;-><init>(Lcom/cleanhdmi/MainActivity;)V
            invoke-interface {v0, v1}, Landroid/view/SurfaceHolder;->addCallback(Landroid/view/SurfaceHolder$Callback;)V
            
            return-void
        .end method
        
        .method private toggleCleanMode()V
            .locals 3
            
            .prologue
            # Toggle clean HDMI mode
            .line 100
            iget-boolean v0, p0, Lcom/cleanhdmi/MainActivity;->isCleanMode:Z
            
            if-nez v0, :cond_0
            const/4 v0, 0x1
            :goto_0
            iput-boolean v0, p0, Lcom/cleanhdmi/MainActivity;->isCleanMode:Z
            
            iget-boolean v0, p0, Lcom/cleanhdmi/MainActivity;->isCleanMode:Z
            if-eqz v0, :cond_1
            
            # Hide UI
            iget-object v0, p0, Lcom/cleanhdmi/MainActivity;->controlLayout:Landroid/widget/LinearLayout;
            const/16 v1, 0x8
            invoke-virtual {v0, v1}, Landroid/widget/LinearLayout;->setVisibility(I)V
            
            # Update status
            iget-object v0, p0, Lcom/cleanhdmi/MainActivity;->statusText:Landroid/widget/TextView;
            const-string v1, "Clean HDMI Active"
            invoke-virtual {v0, v1}, Landroid/widget/TextView;->setText(Ljava/lang/CharSequence;)V
            
            goto :goto_1
            
            :cond_0
            const/4 v0, 0x0
            goto :goto_0
            
            :cond_1
            # Show UI
            iget-object v0, p0, Lcom/cleanhdmi/MainActivity;->controlLayout:Landroid/widget/LinearLayout;
            const/4 v1, 0x0
            invoke-virtual {v0, v1}, Landroid/widget/LinearLayout;->setVisibility(I)V
            
            # Update status
            iget-object v0, p0, Lcom/cleanhdmi/MainActivity;->statusText:Landroid/widget/TextView;
            const-string v1, "Clean HDMI Mode"
            invoke-virtual {v0, v1}, Landroid/widget/TextView;->setText(Ljava/lang/CharSequence;)V
            
            :goto_1
            return-void
        .end method
        
        # Inner classes for click handlers
        .class Lcom/cleanhdmi/MainActivity$1;
        .super Ljava/lang/Object;
        .source "MainActivity.java"
        
        # interfaces
        .implements Landroid/view/View$OnClickListener;
        
        # instance fields
        .field final synthetic this$0:Lcom/cleanhdmi/MainActivity;
        
        # direct methods
        .method constructor <init>(Lcom/cleanhdmi/MainActivity;)V
            .locals 0
            
            .prologue
            iput-object p1, p0, Lcom/cleanhdmi/MainActivity$1;->this$0:Lcom/cleanhdmi/MainActivity;
            invoke-direct {p0}, Ljava/lang/Object;-><init>()V
            return-void
        .end method
        
        # virtual methods
        .method public onClick(Landroid/view/View;)V
            .locals 1
            .param p1, "v"
            
            .prologue
            iget-object v0, p0, Lcom/cleanhdmi/MainActivity$1;->this$0:Lcom/cleanhdmi/MainActivity;
            invoke-static {v0}, Lcom/cleanhdmi/MainActivity;->access$000(Lcom/cleanhdmi/MainActivity;)V
            return-void
        .end method
        
        .end class
        
        .class Lcom/cleanhdmi/MainActivity$2;
        .super Ljava/lang/Object;
        .source "MainActivity.java"
        .implements Landroid/view/View$OnClickListener;
        
        .field final synthetic this$0:Lcom/cleanhdmi/MainActivity;
        
        .method constructor <init>(Lcom/cleanhdmi/MainActivity;)V
            .locals 0
            iput-object p1, p0, Lcom/cleanhdmi/MainActivity$2;->this$0:Lcom/cleanhdmi/MainActivity;
            invoke-direct {p0}, Ljava/lang/Object;-><init>()V
            return-void
        .end method
        
        .method public onClick(Landroid/view/View;)V
            .locals 1
            .param p1, "v"
            iget-object v0, p0, Lcom/cleanhdmi/MainActivity$2;->this$0:Lcom/cleanhdmi/MainActivity;
            invoke-static {v0}, Lcom/cleanhdmi/MainActivity;->access$100(Lcom/cleanhdmi/MainActivity;)V
            return-void
        .end method
        .end class
        
        .class Lcom/cleanhdmi/MainActivity$3;
        .super Ljava/lang/Object;
        .source "MainActivity.java"
        .implements Landroid/view/View$OnClickListener;
        
        .field final synthetic this$0:Lcom/cleanhdmi/MainActivity;
        
        .method constructor <init>(Lcom/cleanhdmi/MainActivity;)V
            .locals 0
            iput-object p1, p0, Lcom/cleanhdmi/MainActivity$3;->this$0:Lcom/cleanhdmi/MainActivity;
            invoke-direct {p0}, Ljava/lang/Object;-><init>()V
            return-void
        .end method
        
        .method public onClick(Landroid/view/View;)V
            .locals 2
            .param p1, "v"
            const-string v0, "CleanHDMI"
            const-string v1, "Focus lock clicked"
            invoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
            return-void
        .end method
        .end class
        
        .class Lcom/cleanhdmi/MainActivity$4;
        .super Ljava/lang/Object;
        .source "MainActivity.java"
        .implements Landroid/view/SurfaceHolder$Callback;
        
        .field final synthetic this$0:Lcom/cleanhdmi/MainActivity;
        
        .method constructor <init>(Lcom/cleanhdmi/MainActivity;)V
            .locals 0
            iput-object p1, p0, Lcom/cleanhdmi/MainActivity$4;->this$0:Lcom/cleanhdmi/MainActivity;
            invoke-direct {p0}, Ljava/lang/Object;-><init>()V
            return-void
        .end method
        
        .method public surfaceCreated(Landroid/view/SurfaceHolder;)V
            .locals 2
            .param p1, "holder"
            const-string v0, "CleanHDMI"
            const-string v1, "Surface created"
            invoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
            return-void
        .end method
        
        .method public surfaceChanged(Landroid/view/SurfaceHolder;III)V
            .locals 2
            .param p1, "holder"
            .param p2, "format"
            .param p3, "width"
            .param p4, "height"
            const-string v0, "CleanHDMI"
            const-string v1, "Surface changed"
            invoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
            return-void
        .end method
        
        .method public surfaceDestroyed(Landroid/view/SurfaceHolder;)V
            .locals 2
            .param p1, "holder"
            const-string v0, "CleanHDMI"
            const-string v1, "Surface destroyed"
            invoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
            return-void
        .end method
        .end class
        
        # Static access methods
        .method static synthetic access$000(Lcom/cleanhdmi/MainActivity;)V
            .locals 0
            .param p0, "x0"
            invoke-direct {p0}, Lcom/cleanhdmi/MainActivity;->toggleCleanMode()V
            return-void
        .end method
        
        .method static synthetic access$100(Lcom/cleanhdmi/MainActivity;)V
            .locals 0
            .param p0, "x0"
            invoke-direct {p0}, Lcom/cleanhdmi/MainActivity;->toggleCleanMode()V
            return-void
        .end method
        EOF
        
        echo "✅ Clean HDMI activity created"
    
    - name: Update app configuration
      run: |
        echo "📝 Updating app configuration..."
        cd work/app
        
        # Update AndroidManifest.xml
        cat > AndroidManifest.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android" 
            package="com.github.ma1co.pmcademo">
            
            <uses-permission android:name="android.permission.CAMERA"/>
            <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
            
            <application 
                android:label="Clean HDMI"
                android:icon="@drawable/ic_launcher">
                
                <activity 
                    android:name="com.cleanhdmi.MainActivity"
                    android:label="Clean HDMI"
                    android:theme="@android:style/Theme.Black.NoTitleBar.Fullscreen"
                    android:screenOrientation="landscape"
                    android:configChanges="orientation|keyboardHidden|screenSize">
                    <intent-filter>
                        <action android:name="android.intent.action.MAIN"/>
                        <category android:name="android.intent.category.LAUNCHER"/>
                    </intent-filter>
                </activity>
                
                <!-- Keep original activities but hidden -->
                <activity 
                    android:name="com.github.ma1co.pmcademo.MainActivity"
                    android:exported="false"/>
                    
            </application>
        </manifest>
        EOF
        
        # Update strings
        if [ -f "res/values/strings.xml" ]; then
          sed -i 's/<string name="app_name">.*<\/string>/<string name="app_name">Clean HDMI<\/string>/g' res/values/strings.xml
          
          # Add new strings
          sed -i '/<\/resources>/i \    <string name="clean_mode_active">Clean HDMI Active - Tap to show controls</string>' res/values/strings.xml
          sed -i '/<\/resources>/i \    <string name="toggle_clean">Toggle Clean Mode</string>' res/values/strings.xml
          sed -i '/<\/resources>/i \    <string name="lock_focus">Lock Focus</string>' res/values/strings.xml
          sed -i '/<\/resources>/i \    <string name="lock_exposure">Lock Exposure</string>' res/values/strings.xml
        fi
        
        echo "✅ Configuration updated"
    
    - name: Build APK
      run: |
        echo "🔨 Building Clean HDMI APK..."
        cd work
        
        java -jar apktool.jar b app -o CleanHDMI_unsigned.apk
        
        if [ ! -f "CleanHDMI_unsigned.apk" ]; then
          echo "❌ Build failed"
          exit 1
        fi
        
        echo "✅ APK built successfully"
        ls -lh CleanHDMI_unsigned.apk
    
    - name: Sign APK
      run: |
        echo "🔐 Signing APK..."
        cd work
        
        # Create keystore
        keytool -genkeypair \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -alias cleanhdmi \
          -keystore cleanhdmi.keystore \
          -storepass android \
          -keypass android \
          -dname "CN=CleanHDMI,O=GitHub,C=US" \
          -noprompt
        
        # Sign APK
        jarsigner \
          -sigalg SHA1withRSA \
          -digestalg SHA1 \
          -keystore cleanhdmi.keystore \
          -storepass android \
          -signedjar CleanHDMI.apk \
          CleanHDMI_unsigned.apk \
          cleanhdmi
        
        echo "✅ APK signed"
        ls -lh CleanHDMI.apk
    
    - name: Create user guide
      run: |
        echo "📚 Creating user guide..."
        cd work
        
        cat > USER_GUIDE.txt << 'EOF'
        Clean HDMI for Sony DSC-HX400 - User Guide
        ==========================================
        
        FEATURES:
        ---------
        ✓ Clean HDMI output without UI elements
        ✓ Toggle UI visibility with screen tap
        ✓ Focus lock control
        ✓ Exposure lock control
        ✓ Full screen preview
        ✓ Landscape orientation optimized
        
        HOW TO USE:
        -----------
        1. Install the app on your camera
        2. Launch "Clean HDMI" from camera menu
        3. The app starts with controls visible
        4. Tap "Toggle Clean Mode" to hide all UI
        5. HDMI output is now clean!
        6. Tap anywhere on screen to show/hide controls
        
        CONTROLS:
        ---------
        • Toggle Clean Mode - Hide/show all UI elements
        • Lock Focus - Prevent autofocus changes
        • Lock Exposure - Fix current exposure settings
        • Tap screen - Quick toggle UI visibility
        
        TIPS:
        -----
        • Connect HDMI cable before launching app
        • Use Clean Mode for recording/streaming
        • Controls are hidden but still accessible
        • Camera buttons remain functional
        
        INSTALLATION:
        -------------
        pmca-console.exe install -f CleanHDMI.apk
        
        Version: 1.0
        Build Date: $(date)
        EOF
        
        echo "✅ User guide created"
        
        echo ""
        echo "========================================="
        echo "✅ CLEAN HDMI APP BUILD COMPLETE!"
        echo "========================================="
        echo ""
        echo "The app includes:"
        echo "• Clean HDMI mode (hides all UI)"
        echo "• Touch controls"
        echo "• Focus/Exposure lock"
        echo "• Full screen preview"
    
    - name: Upload final APK
      uses: actions/upload-artifact@v4
      with:
        name: CleanHDMI-Final-${{ github.run_number }}
        path: |
          work/CleanHDMI.apk
          work/USER_GUIDE.txt
        retention-days: 90
        if-no-files-found: error
